version: 2.1

########################
# Workflow Definitions #
########################
workflows:
  main:
    jobs:
      - runner-test:
          context: Info-b23prodtm

###################
# Job Definitions #
###################
jobs:
  runner-test:
    resource_class: b23prodtm/linux
    docker:
      - image: ghcr.io/nestybox/ubuntu-jammy-systemd-docker
        entrypoint: ["/sbin/init"]
      #- image: cimg/base:2024.12
    steps:
      - checkout
      - run:
          name: Verify environment
          command: |
            printenv
      - run:
          name: Install podman and minikube
          command: |
            echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
            ./configure_podman.sh
      - run:
          name: Install helm and charts
          command: |
            set -eu
            cp values.yaml.example values.yaml
            sed -i -e "s/YOUR_CIRCLECI_TOKEN_HERE/${K8S_RUNNER_TOKEN}/" \
            -e "s#MY_ORG/RESOURCE_CLASS_HERE#${K8S_RUNNER_RESOURCE}#" values.yaml
            ./install_ssh_gateway.sh
      - run:
          name: Cleanup cluster
          command: |
            minikube delete -p sysbox || true
